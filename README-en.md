### introduction
 Xiushang boot .

 A lightweight microservice architecture implemented with springboot + Dubbo + rocketmq + JPA.

 Develop API interface project and complete API general functions: user module, API authorization, SMS, scheduled task, upload file, document management and wechat related interfaces.
 Main technology stack：springboot dubbo rocketMQ jpa oauth2 solr job pay marketingApi knife4j Swagger2  
 
  demo：https://github.com/shijingsh/xiushang-boot/tree/master/xiushang-boot-example
  
### Database script

   Modify the database connection in the application.yml file to your database 
```
spring:
  datasource:
    username: proxy1
    password: proxy1
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://192.168.29.11:3306/mg_xiushang?useUnicode=true&useSSL=false&characterEncoding=utf8&serverTimezone=GMT%2b8
    type: com.alibaba.druid.pool.DruidDataSource
```
    
   The database script that the project depends on is automatically generated by hibernate. An empty database needs to be created.
   
   application. In the YML file, ensure that the DDL auto option is set to create
   
```
     jpa:
       properties:
         hibernate:
           dialect: org.hibernate.dialect.MySQL5InnoDBDialect
       hibernate:
         ddl-auto: update # Hibernate ddl auto (create, create-drop, validate, update)
```

   Note: after the database is generated, be sure to modify the DDL auto option to update to avoid data emptying.
   

### Entity 
    

JPA is very convenient for simple business, in order to achieve a simple code style. It is agreed that all entity classes do not use one to many

Entity classes should be fewer than object cascades.


JPA auto generated class cannot find problem: Q * * * entity is not found

Run the following command to solve the problem

```
mvn clean 
mvn install
```

### usage

Select the library you need to install

```xml
        <dependency>
            <groupId>com.github.shijingsh</groupId>
            <artifactId>xs-core</artifactId>
            <version>1.4.4</version>
        </dependency>
        <dependency>
            <groupId>com.github.shijingsh</groupId>
            <artifactId>xs-entity</artifactId>
            <version>1.4.4</version>
        </dependency>
        <dependency>
            <groupId>com.github.shijingsh</groupId>
            <artifactId>xs-service</artifactId>
            <version>1.4.4</version>
        </dependency>
        <dependency>
            <groupId>com.github.shijingsh</groupId>
            <artifactId>xs-jwt-security</artifactId>
            <version>1.4.4</version>
        </dependency>
        <dependency>
            <groupId>com.github.shijingsh</groupId>
            <artifactId>xs-common</artifactId>
            <version>1.4.4</version>
        </dependency>
        <dependency>
            <groupId>com.github.shijingsh</groupId>
            <artifactId>xs-dubbo</artifactId>
            <version>1.4.4</version>
        </dependency>
        <dependency>
            <groupId>com.github.shijingsh</groupId>
            <artifactId>xs-rocketmq</artifactId>
            <version>1.4.4</version>
        </dependency>
        <dependency>
            <groupId>com.github.shijingsh</groupId>
            <artifactId>xs-marketing</artifactId>
            <version>1.4.4</version>
        </dependency>
        <dependency>
            <groupId>com.github.shijingsh</groupId>
            <artifactId>xs-solr</artifactId>
            <version>1.4.4</version>
        </dependency>
        <dependency>
            <groupId>com.github.shijingsh</groupId>
            <artifactId>xs-job</artifactId>
            <version>1.4.4</version>
        </dependency>
```


### api Multi version control
        

- Add annotation on method  @ApiVersion
- Add  {version} in mapping
    For example: @GetMapping("/{version}/get")

-  The annotation @ apiversion is added to the class to represent the default version number 1
   (note that {version} needs to be added in mapping)
  
```java
@ApiVersion
@Api(tags = "常用接口")
@Controller
@RequestMapping(value = "/api/news",
        produces = "application/json; charset=UTF-8")
public class NewsController {

    @ApiOperation(value = "获取公告详情")
    @ResponseBody
    @GetMapping("/{version}/get")
    public CommonResult<NewsEntity> get(String id) {

        return CommonResult.success();
    }

    @ApiVersion(2)
    @ApiOperation(value = "获取公告详情V2")
    @ResponseBody
    @GetMapping("/{version}/get")
    public CommonResult<NewsEntity> get(String id) {

        return CommonResult.success();
    }

}
```
-  Swagger2 configuring multiple versions

```java
@Configuration
@EnableSwagger2WebMvc
@Import(BeanValidatorPluginsConfiguration.class)
public class SwaggerConfiguration {

    @Bean
    public Docket v1Default(){
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(groupApiInfo())
                .groupName("1-V1版本")
                .select()
                .apis(input -> {
                    ApiVersion apiVersion = input.getHandlerMethod().getMethodAnnotation(ApiVersion.class);
                    if(apiVersion!=null){
                        System.out.println("读取到版本信息："+apiVersion.value());
                    }
                    if(apiVersion!=null && Arrays.asList(apiVersion.value()).contains(1)){
                        return true;
                    }
                    // 方法所在的类是否标注
                    ApiVersion annotationOnClass = input.getHandlerMethod().getBeanType().getAnnotation(ApiVersion.class);
                    if (annotationOnClass != null) {
                        if (Arrays.asList(annotationOnClass.value()).contains(1)) {
                            return true;
                        }
                    }
                    return false;
                })//controller路径
                .paths(PathSelectors.any())
                .build();
    }
}
```

### Use of redis
    

```java
@Api(tags = "redis 缓存")
@Controller
@RequestMapping(value = "/redis",
        produces = "application/json; charset=UTF-8")
public class RedisController {
    @Resource(name = "jsonRedisClient")
    private JsonRedisClient jsonRedisClient;

    @ApiOperation(value = "获取redis数据")
    @ResponseBody
    @GetMapping("/myRedis")
    public CommonResult<String> myRedis(String type) {
        
        jsonRedisClient.set("key","value", new Long(24 * 60 * 60 * 60));
        jsonRedisClient.remove("key");
        jsonRedisClient.getValue("key",String.class);
        
        return CommonResult.success();
    }
}
```


### Auth2 authorization configuration
    
Configure oauth2 authorization path in application.yml (default: /api/)

```
oauth:
  path:
    url: /api/
```

####  Interface request header parameter
      

- Authorization：Request protected interface is required



####  Authorized  description

 [OAUTH2](xs-jwt-security/OAUTH2.md)
 
#### OAuth2 Database table

https://github.com/spring-projects/spring-security-oauth/blob/main/spring-security-oauth2/src/test/resources/schema.sql

Table structure description：https://blog.csdn.net/qq_34997906/article/details/89609297


### dubbo Microservice integration
          

Add dependency

```xml
        <dependency>
            <groupId>com.github.shijingsh</groupId>
            <artifactId>xs-dubbo</artifactId>
            <version>1.4.4</version>
            <type>jar</type>
        </dependency>
```

#### dubbo interface
```java
package com.xiushang.dubbo.service;

import com.xiushang.framework.log.CommonResult;

public interface OrderDubboService {
    CommonResult<String> getHelloWord();
}

```

#### dubbo provider
```java
package com.xiushang.dubbo.service;


import com.xiushang.framework.log.CommonResult;
import org.apache.dubbo.config.annotation.DubboService;


@DubboService()
public class OrderDubboSericeImpl implements OrderDubboService {

    @Override
    public CommonResult<String> getHelloWord() {
        return CommonResult.success("hello world");
    }
}

```

#### Dubbo interface usage


```java
package com.xiushang.dubbo.controller;

import com.xiushang.dubbo.service.OrderDubboService;
import com.xiushang.framework.log.CommonResult;
import org.apache.dubbo.config.annotation.DubboReference;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;


@RestController()
@RequestMapping("/consumer")
public class ConsumerController {
    @DubboReference
    OrderDubboService orderDubboService;

    @GetMapping("getOrder")
    public CommonResult<String> getOrder() {
        return orderDubboService.getHelloWord();
    }
}

```

#### dubbo Configuration related

```
server:
  port: 7000
spring:
  application:
    name: order-consumer
# dubbo 相关配置
dubbo:
  application:
    # 应用名称
    name: order-provider
  scan:
  # 接口实现者（服务实现）包
   base-packages: com.xiushang.dubbo.service
  # 注册中心信息
  registry:
    address: zookeeper://192.168.29.12:2181
  protocol:
    # 协议名称
    name: dubbo
    # 协议端口
    port: 20880

```
    
### constraint


### domain
- www.xiushangsh.com
